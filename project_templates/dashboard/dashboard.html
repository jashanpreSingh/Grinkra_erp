{% extends 'base.html' %}

{% block title %}Dashboard - Grinkrawear{% endblock %}

{% block extra_css %}
<style>
    .chart-container {
        background: #fff;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        margin-bottom: 20px;
    }
    .chart-container h5 {
        margin-bottom: 15px;
        color: #333;
    }
    .chart-wrapper {
        position: relative;
        height: 300px;
    }
    .nav-pills .nav-link {
        color: #666;
    }
    .nav-pills .nav-link.active {
        background-color: #0d6efd;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-header">
    <h1><i class="bi bi-speedometer2"></i> Dashboard</h1>
</div>

<!-- Stats Cards -->
<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="card stat-card primary">
            <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                    <h6 class="text-muted mb-1">Today's Sales</h6>
                    <h3 class="mb-0">₹{{ today_sales }}</h3>
                    <small class="text-muted">{{ today_invoice_count }} invoices</small>
                </div>
                <i class="bi bi-currency-rupee icon text-primary"></i>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card stat-card success">
            <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                    <h6 class="text-muted mb-1">This Month</h6>
                    <h3 class="mb-0">₹{{ month_sales }}</h3>
                    <small class="text-muted">Total revenue</small>
                </div>
                <i class="bi bi-graph-up-arrow icon text-success"></i>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card stat-card warning">
            <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                    <h6 class="text-muted mb-1">Pending</h6>
                    <h3 class="mb-0">₹{{ pending_amount }}</h3>
                    <small class="text-muted">{{ pending_count }} invoices</small>
                </div>
                <i class="bi bi-clock-history icon text-warning"></i>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card stat-card danger">
            <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                    <h6 class="text-muted mb-1">Low Stock</h6>
                    <h3 class="mb-0">{{ low_stock_count }}</h3>
                    <small class="text-muted">{{ out_of_stock_count }} out of stock</small>
                </div>
                <i class="bi bi-exclamation-triangle icon text-danger"></i>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="row mb-4">
    <div class="col-md-2 col-6 mb-3">
        <a href="{% url 'invoice_create' %}" class="quick-action-card">
            <i class="bi bi-receipt text-primary"></i>
            <span>New Invoice</span>
        </a>
    </div>
    <div class="col-md-2 col-6 mb-3">
        <a href="{% url 'product_create' %}" class="quick-action-card">
            <i class="bi bi-plus-circle text-success"></i>
            <span>Add Product</span>
        </a>
    </div>
    <div class="col-md-2 col-6 mb-3">
        <a href="{% url 'customer_create' %}" class="quick-action-card">
            <i class="bi bi-person-plus text-info"></i>
            <span>Add Customer</span>
        </a>
    </div>
    <div class="col-md-2 col-6 mb-3">
        <a href="{% url 'product_list' %}" class="quick-action-card">
            <i class="bi bi-box-seam text-secondary"></i>
            <span>Inventory</span>
        </a>
    </div>
    <div class="col-md-2 col-6 mb-3">
        <a href="{% url 'invoice_list' %}" class="quick-action-card">
            <i class="bi bi-list-ul text-secondary"></i>
            <span>All Invoices</span>
        </a>
    </div>
    <div class="col-md-2 col-6 mb-3">
        <a href="{% url 'customer_list' %}" class="quick-action-card">
            <i class="bi bi-people text-secondary"></i>
            <span>Customers</span>
        </a>
    </div>
</div>

<div class="row">
    <!-- Recent Invoices -->
    <div class="col-lg-8 mb-4">
        <div class="table-container">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0"><i class="bi bi-receipt"></i> Recent Invoices</h5>
                <a href="{% url 'invoice_list' %}" class="btn btn-sm btn-outline-primary">View All</a>
            </div>
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th>Invoice</th>
                        <th>Customer</th>
                        <th>Amount</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for invoice in recent_invoices %}
                    <tr>
                        <td>
                            <a href="{% url 'invoice_detail' invoice.pk %}" class="text-decoration-none">
                                {{ invoice.invoice_number }}
                            </a>
                            <br><small class="text-muted">{{ invoice.created_at|date:"M d, H:i" }}</small>
                        </td>
                        <td>{{ invoice.get_customer_display }}</td>
                        <td>₹{{ invoice.total_amount }}</td>
                        <td>
                            {% if invoice.status == 'paid' %}
                            <span class="badge bg-success">Paid</span>
                            {% elif invoice.status == 'pending' %}
                            <span class="badge bg-warning text-dark">Pending</span>
                            {% else %}
                            <span class="badge bg-danger">Cancelled</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="4" class="text-center text-muted py-3">No invoices yet</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Low Stock Alerts -->
    <div class="col-lg-4 mb-4">
        <div class="table-container">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0"><i class="bi bi-exclamation-triangle text-warning"></i> Low Stock Alert</h5>
                <a href="{% url 'product_list' %}?stock_status=low_stock" class="btn btn-sm btn-outline-warning">View All</a>
            </div>
            {% if low_stock_list %}
            <ul class="list-group list-group-flush">
                {% for product in low_stock_list %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <a href="{% url 'product_detail' product.pk %}" class="text-decoration-none">
                            {{ product.name }}
                        </a>
                        <br><small class="text-muted">{{ product.sku }}</small>
                    </div>
                    <span class="badge {% if product.quantity == 0 %}bg-danger{% else %}bg-warning text-dark{% endif %}">
                        {{ product.quantity }} left
                    </span>
                </li>
                {% endfor %}
            </ul>
            {% else %}
            <p class="text-muted text-center py-3 mb-0">All products are well stocked</p>
            {% endif %}
        </div>
    </div>
</div>

<!-- Quick Stats -->
<div class="row">
    <div class="col-md-4 mb-3">
        <div class="form-container text-center">
            <i class="bi bi-box-seam fs-1 text-primary"></i>
            <h3 class="mt-2">{{ total_products }}</h3>
            <p class="text-muted mb-0">Total Products</p>
        </div>
    </div>
    <div class="col-md-4 mb-3">
        <div class="form-container text-center">
            <i class="bi bi-people fs-1 text-info"></i>
            <h3 class="mt-2">{{ total_customers }}</h3>
            <p class="text-muted mb-0">Customers</p>
        </div>
    </div>
    <div class="col-md-4 mb-3">
        <div class="form-container text-center">
            <i class="bi bi-tags fs-1 text-success"></i>
            <h3 class="mt-2">{{ today_invoice_count }}</h3>
            <p class="text-muted mb-0">Today's Invoices</p>
        </div>
    </div>
</div>

<!-- Sales Charts Section -->
<div class="row mt-4">
    <div class="col-12">
        <div class="chart-container">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0"><i class="bi bi-graph-up"></i> Sales Analytics</h5>
                <ul class="nav nav-pills" id="salesChartTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="daily-tab" data-bs-toggle="pill" data-bs-target="#daily-chart" type="button">Daily</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="weekly-tab" data-bs-toggle="pill" data-bs-target="#weekly-chart" type="button">Weekly</button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="monthly-tab" data-bs-toggle="pill" data-bs-target="#monthly-chart" type="button">Monthly</button>
                    </li>
                </ul>
            </div>
            <div class="tab-content">
                <div class="tab-pane fade show active" id="daily-chart">
                    <div class="chart-wrapper">
                        <canvas id="dailySalesChart"></canvas>
                    </div>
                </div>
                <div class="tab-pane fade" id="weekly-chart">
                    <div class="chart-wrapper">
                        <canvas id="weeklySalesChart"></canvas>
                    </div>
                </div>
                <div class="tab-pane fade" id="monthly-chart">
                    <div class="chart-wrapper">
                        <canvas id="monthlySalesChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Product Movement Charts -->
<div class="row">
    <div class="col-lg-6 mb-4">
        <div class="chart-container">
            <h5><i class="bi bi-arrow-up-circle text-success"></i> Top Moving Products <small class="text-muted">(Last 30 Days)</small></h5>
            {% if moving_count > 0 %}
            <div class="chart-wrapper">
                <canvas id="movingProductsChart"></canvas>
            </div>
            {% else %}
            <div class="text-center text-muted py-5">
                <i class="bi bi-inbox fs-1"></i>
                <p class="mt-2">No sales data available</p>
            </div>
            {% endif %}
        </div>
    </div>
    <div class="col-lg-6 mb-4">
        <div class="chart-container">
            <h5><i class="bi bi-arrow-down-circle text-danger"></i> Non-Moving Products <small class="text-muted">(No Sales in 30 Days)</small></h5>
            {% if non_moving_count > 0 %}
            <div class="chart-wrapper">
                <canvas id="nonMovingProductsChart"></canvas>
            </div>
            {% else %}
            <div class="text-center text-muted py-5">
                <i class="bi bi-check-circle fs-1 text-success"></i>
                <p class="mt-2">All products are selling!</p>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Chart.js default config
    Chart.defaults.font.family = "'Segoe UI', system-ui, sans-serif";
    Chart.defaults.responsive = true;
    Chart.defaults.maintainAspectRatio = false;

    // Daily Sales Chart
    const dailyCtx = document.getElementById('dailySalesChart');
    if (dailyCtx) {
        new Chart(dailyCtx, {
            type: 'line',
            data: {
                labels: {{ daily_labels|safe }},
                datasets: [{
                    label: 'Daily Sales (₹)',
                    data: {{ daily_data|safe }},
                    borderColor: '#0d6efd',
                    backgroundColor: 'rgba(13, 110, 253, 0.1)',
                    fill: true,
                    tension: 0.3,
                    pointBackgroundColor: '#0d6efd',
                    pointRadius: 5,
                    pointHoverRadius: 7
                }]
            },
            options: {
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '₹' + value.toLocaleString();
                            }
                        }
                    }
                }
            }
        });
    }

    // Weekly Sales Chart
    const weeklyCtx = document.getElementById('weeklySalesChart');
    if (weeklyCtx) {
        new Chart(weeklyCtx, {
            type: 'bar',
            data: {
                labels: {{ weekly_labels|safe }},
                datasets: [{
                    label: 'Weekly Sales (₹)',
                    data: {{ weekly_data|safe }},
                    backgroundColor: '#198754',
                    borderRadius: 5
                }]
            },
            options: {
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '₹' + value.toLocaleString();
                            }
                        }
                    }
                }
            }
        });
    }

    // Monthly Sales Chart
    const monthlyCtx = document.getElementById('monthlySalesChart');
    if (monthlyCtx) {
        new Chart(monthlyCtx, {
            type: 'bar',
            data: {
                labels: {{ monthly_labels|safe }},
                datasets: [{
                    label: 'Monthly Sales (₹)',
                    data: {{ monthly_data|safe }},
                    backgroundColor: '#6f42c1',
                    borderRadius: 5
                }]
            },
            options: {
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '₹' + value.toLocaleString();
                            }
                        }
                    }
                }
            }
        });
    }

    // Moving Products Chart
    const movingCtx = document.getElementById('movingProductsChart');
    if (movingCtx) {
        new Chart(movingCtx, {
            type: 'bar',
            data: {
                labels: {{ moving_labels|safe }},
                datasets: [{
                    label: 'Quantity Sold',
                    data: {{ moving_qty_data|safe }},
                    backgroundColor: '#20c997',
                    borderRadius: 5
                }]
            },
            options: {
                indexAxis: 'y',
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                }
            }
        });
    }

    // Non-Moving Products Chart
    const nonMovingCtx = document.getElementById('nonMovingProductsChart');
    if (nonMovingCtx) {
        new Chart(nonMovingCtx, {
            type: 'bar',
            data: {
                labels: {{ non_moving_labels|safe }},
                datasets: [{
                    label: 'Current Stock',
                    data: {{ non_moving_stock|safe }},
                    backgroundColor: '#dc3545',
                    borderRadius: 5
                }]
            },
            options: {
                indexAxis: 'y',
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1
                        }
                    }
                }
            }
        });
    }
});
</script>
{% endblock %}
